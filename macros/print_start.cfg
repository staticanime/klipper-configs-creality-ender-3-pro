[gcode_macro PRINT_START]
gcode:
    {% set bed_temp = params.BED_TEMP|default(60)|int %}
    {% set chamber_temp = params.CHAMBER_TEMP|default(0)|int %}
    {% set hotend_temp = params.HOTEND_TEMP|default(200)|int %}
    {% set relative_extrusion_mode = params.RELATIVE_E_MODE|default(0)|int %}
    {% set filament_type = params.FILAMENT|default(PLA)|string %}

    G90 ;Absolute positioning
    M220 S100 ;Reset feedrate
    M221 S100 ;Reset flowrate
    {% if relative_extrusion_mode == '1' %}
      M83 ;Set extruder to relative mode
    {% else %}
      M82 ;Set extruder to absolute mode
    {% endif %}


    SET_GCODE_OFFSET Z=0.0 MOVE=0   ; Zero the Z index again
    BED_MESH_CLEAR

    M117 Homing XYZ
    _STATUS_LEDHOMING
    CG28 ;Home All
    _STATUS_LEDREADY

    M117 Heating bed and chamber 
    _STATUS_LEDHEATING
    M190 S{bed_temp} ;Wait for bed to reach temp target
    {% if filament_type == "ABS" or filament_type == "ASA" %}
      G4 P300000 ;Wait 5 minutes to heat soak
    {% endif %}
    _STATUS_LEDREADY

    M117 Preheating Nozzle
    _STATUS_LEDHEATING
    M109 S150
    _STATUS_LEDREADY

    G4 P30000 ; Wait 30s for temps to stabalise

    M117 Calibrate Z
    _STATUS_LEDCALIBRATING_Z
    G28 Z
    _STATUS_LEDREADY

    M117 Probing Bed Mesh
    _STATUS_LEDMESHING
    BED_MESH_CALIBRATE ADAPTIVE=1
    _STATUS_LEDREADY

    M117 Heating Nozzle
    _STATUS_LEDHEATING
    M109 S{hotend_temp} ;Finish heating hotend
    _STATUS_LEDREADY

    M117 Smart Park
    # _STATUS_LEDREADY
    SMART_PARK
    # _STATUS_LEDREADY

    M117 Purge Line
    _STATUS_LEDREADY
    LINE_PURGE
    #VORON_PURGE
  
    _STATUS_LEDPRINTING
    M117 Printing...
